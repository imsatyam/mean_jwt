(function() {

	angular.module('meanjwt')
			.controller('navigationController', navigationController);

	navigationController.$inject = [ '$location', 'authentication' ];
	function navigationController($location, authentication) {
		var vm = this;

		vm.isLoggedIn = authentication.isLoggedIn();

		vm.currentUser = authentication.currentUser();

	}

})();;(function () {

  angular
    .module('meanjwt')
    .directive('navigation', navigation);

  function navigation () {
    return {
      restrict: 'EA',
      templateUrl: '/common/directive/navigation/navigation.template.html',
      controller: 'navigationController as navvm'
    };
  }

})();;(function () {

  angular
    .module('meanjwt')
    .service('authentication', authentication);

  authentication.$inject = ['$http', '$window'];
  function authentication ($http, $window) {

    var saveToken = function (token) {
      $window.localStorage['mean-token'] = token;
    };

    var getToken = function () {
      return $window.localStorage['mean-token'];
    };

    var isLoggedIn = function() {
      var token = getToken();
      var payload;

      if(token){
        payload = token.split('.')[1];
        payload = $window.atob(payload);
        payload = JSON.parse(payload);

        return payload.exp > Date.now() / 1000;
      } else {
        return false;
      }
    };

    var currentUser = function() {
      if(isLoggedIn()){
        var token = getToken();
        var payload = token.split('.')[1];
        payload = $window.atob(payload);
        payload = JSON.parse(payload);
        return {
		  id : payload.id,
          email : payload.email,
          name : payload.name
        };
      }
    };

    register = function(user) {
      return $http.post('/api/register', user).success(function(data){
        console.log ("Registration complete...");
      });
    };

    login = function(user) {
      return $http.post('/api/login', user).success(function(data) {
        saveToken(data.token);
      });
    };

    logout = function() {
      $window.localStorage.removeItem('mean-token');
    };

    return {
      currentUser : currentUser,
      saveToken : saveToken,
      getToken : getToken,
      isLoggedIn : isLoggedIn,
      register : register,
      login : login,
      logout : logout
    };
  }


})();;(function() {

	angular.module('meanjwt').service('meanData', meanData);

	meanData.$inject = [ '$http', 'authentication' ];
	function meanData($http, authentication) {

		return {
			getProfile : function(configObj) {
				var url = "/api/profile/" + configObj.userId;
				return $http.get(url, {
					headers : {
						Authorization : 'Bearer ' + authentication.getToken()
					}
				});
			}
		};
		
	}

})();;(function() {
  
  angular
    .module('meanjwt')
    .controller('homeController', homeController);

    function homeController () {
      console.log('Starting home controller...');
    }

})();;(function() {

	angular.module('meanjwt').controller('loginController', loginController);

	loginController.$inject = ['$scope','$state', '$stateParams', '$location', 'authentication' ];
	function loginController($scope, $state, $stateParams, $location, authentication) {

		$scope.credentials = {
			email : "",
			password : ""
		};

		$scope.onSubmit = function() {
			authentication.login($scope.credentials).error(function(err) {
				alert(err);
			}).then(function() {
				var currentUser = authentication.currentUser();
				$state.go('profile', {userId : currentUser.id});
			});
		};

	}

})();;(function() {
  
  angular
    .module('meanjwt')
    .controller('profileController', profileController);

  profileController.$inject = ['$scope','$state', '$stateParams', '$location', 'meanData'];
  function profileController($scope, $state, $stateParams, $location, meanData) {

	$scope.user = {};
	$scope.userId = $stateParams.userId;

	$scope.configObj = {};
	$scope.configObj.userId = $scope.userId;
	
    meanData.getProfile($scope.configObj)
      .success(function(data) {
    	  $scope.user = data;
      })
      .error(function (e) {
        console.log(e);
      });
  }

})();;(function() {

	angular.module('meanjwt').controller('registrationController', registrationController);

	registrationController.$inject = ['$scope','$state', '$stateParams', '$location', 'authentication' ];
	function registrationController($scope, $state, $stateParams, $location, authentication) {

		$scope.registrationSuccessful = false;
		$scope.regDetails = {
			name : "",
			email : "",
			password : ""
		};

		$scope.onRegSubmit = function() {
			console.log('Making registration...');
			authentication.register($scope.regDetails).error(function(err) {
				alert(err);
			}).then(function() {
				$scope.registrationSuccessful = true;
			});
		};

	}

})();